// SetFlow Database Schema
// Migrated from Dexie/IndexedDB to Prisma/PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// Core Models
// ============================================================

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String?  // For feature gating (e.g., nutrition)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  exercises         Exercise[]
  programs          Program[]
  workoutLogs       WorkoutLog[]
  personalRecords   PersonalRecord[]
  settings          UserSettings?
  onboardingProfile OnboardingProfile?
  achievements      Achievement[]
  activeSession     ActiveSession?
  backups           Backup[]
  nutritionLogs     NutritionLog[]
  mealPlans         MealPlan[]
  supplementLogs    SupplementLog[]
  // Custom nutrition (SetFlow v2.0)
  customMeals         CustomMeal[]
  customSupplements   CustomSupplement[]
  supplementProtocol  SupplementProtocol?
  // Community features (SetFlow v2.0 - Phase 3)
  userProfile             UserProfile?
  followers               Follow[]              @relation("Following")
  following               Follow[]              @relation("Followers")
  createdGroups           Group[]               @relation("GroupCreator")
  groupMemberships        GroupMember[]
  challengeParticipations ChallengeParticipant[]
  badges                  UserBadge[]
  // Focus sessions (SetFlow v2.0 - Phase 4)
  focusSessions           FocusSession[]
  // Gamification (SetFlow v2.0 - XP System)
  gamification            UserGamification?
}

model Exercise {
  id           String   @id @default(cuid())
  builtInId    String?  @unique // Original preset ID (e.g., "ex-barbell-bench")
  name         String
  videoUrl     String?
  muscleGroups String[]
  muscles      Json?    // { primary: string[], secondary: string[] }
  equipment    String
  isCustom     Boolean  @default(false)
  createdAt    DateTime @default(now())

  // User relation (null for built-in exercises)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Back relations
  personalRecords PersonalRecord[]

  @@index([userId])
  @@index([name])
  @@index([builtInId])
}

model Program {
  id          String    @id @default(cuid())
  name        String
  description String?
  isActive    Boolean   @default(false)
  archivedAt  DateTime? // Null = not archived, set = archived timestamp
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  trainingDays TrainingDay[]
  workoutLogs  WorkoutLog[]

  @@index([userId])
  @@index([isActive])
  @@index([archivedAt])
}

model TrainingDay {
  id        String @id @default(cuid())
  name      String
  dayNumber Int

  // Program relation
  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  // JSON fields for complex nested structures
  warmup    Json @default("[]") // WarmupExercise[]
  supersets Json @default("[]") // Superset[]
  finisher  Json @default("[]") // FinisherExercise[]

  // Back relations
  workoutLogs WorkoutLog[]

  @@index([programId])
  @@index([dayNumber])
}

model WorkoutLog {
  id        String   @id @default(cuid())
  date      String   // ISO date string (YYYY-MM-DD)
  dayName   String
  startTime DateTime
  endTime   DateTime?
  duration  Int?     // minutes
  notes     String?
  isComplete Boolean @default(false)

  // Relations - programId nullable to preserve logs when program archived/deleted
  programId   String?
  program     Program?  @relation(fields: [programId], references: [id], onDelete: SetNull)
  programName String?   // Denormalized for display when program is null

  dayId String
  day   TrainingDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // JSON field for sets (SetLog[])
  sets Json @default("[]")

  // Back relations
  personalRecords PersonalRecord[]

  @@index([userId])
  @@index([date])
  @@index([programId])
  @@index([dayId])
  @@index([isComplete])
}

model PersonalRecord {
  id           String   @id @default(cuid())
  exerciseName String
  weight       Float
  reps         Int
  unit         String   // "kg" or "lbs"
  date         String   // ISO date string

  // Relations
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  workoutLogId String
  workoutLog   WorkoutLog @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
  @@index([userId])
  @@index([date])
}

model UserSettings {
  id                   String  @id @default(cuid())
  weightUnit           String  @default("kg") // "kg" or "lbs"
  defaultRestSeconds   Int     @default(90)
  soundEnabled         Boolean @default(true)
  autoProgressWeight   Boolean @default(true)
  progressionIncrement Float   @default(2.5) // kg
  autoStartRestTimer   Boolean @default(true)

  // One-to-one with User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model OnboardingProfile {
  id                     String   @id @default(cuid())
  goals                  String[] // ["build_muscle", "lose_fat", etc.]
  experienceLevel        String?  // "beginner" | "intermediate" | "advanced"
  trainingDaysPerWeek    Int?
  equipment              String?  // "full_gym" | "home_gym" | "bodyweight"
  heightCm               Float?
  weightKg               Float?
  bodyFatPercent         Float?
  injuries               String[] // ["shoulder", "back", etc.]
  hasCompletedOnboarding Boolean  @default(false)
  skippedOnboarding      Boolean  @default(false)
  completedAt            DateTime?

  // Onboarding state machine: "not_started" | "profile_complete" | "program_installing" | "complete"
  onboardingState        String   @default("not_started")

  // One-to-one with User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Achievement {
  id            String   @id @default(cuid())
  achievementId String   // Maps to ACHIEVEMENTS array in achievements.ts
  unlockedAt    DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

// Active workout session for cross-device resume
model ActiveSession {
  id              String   @id @default(cuid())
  dayId           String   // TrainingDay ID
  phase           String   // "warmup" | "exercise" | "rest" | "finisher"
  workoutState    Json     // {supersetIndex, exerciseIndex, setNumber}
  completedSets   Json     // SetLog[]
  warmupChecked   Json     // boolean[]
  finisherChecked Json     // boolean[]
  currentVolume   Float    @default(0)
  startTime       DateTime
  lastUpdated     DateTime @updatedAt
  deviceId        String?  // Optional device identifier

  // One active session per user
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([dayId])
}

// Backup for data protection before destructive operations
model Backup {
  id         String   @id @default(cuid())
  backupName String
  data       String   @db.Text // JSON export of user data
  reason     String   // "pre-reset", "pre-deploy", "user-initiated"
  createdAt  DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================================
// Nutrition Models (Feature-gated to k@adu.dk)
// ============================================================

// Daily nutrition compliance tracking
model NutritionLog {
  id               String   @id @default(cuid())
  date             String   // YYYY-MM-DD
  hitProteinGoal   Boolean  @default(false)
  caloriesOnTarget Boolean  @default(false)
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// Daily meal plan with drag-drop slots
model MealPlan {
  id        String   @id @default(cuid())
  date      String   // YYYY-MM-DD
  slots     Json     // { breakfast: "B1", midMorning: "M2", lunch: "L3", snack: "S1", dinner: "D2" }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// Daily supplement tracking
model SupplementLog {
  id        String   @id @default(cuid())
  date      String   // YYYY-MM-DD
  dayType   String   // 'rest' | 'am-training' | 'pm-training'
  completed Json     // Array of completed supplement IDs
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// ============================================================
// Custom Nutrition Models (SetFlow v2.0)
// ============================================================

// User-created custom meals
model CustomMeal {
  id          String   @id @default(cuid())
  name        String
  category    String   // breakfast | midMorning | lunch | snack | dinner
  protein     Int
  carbs       Int
  fat         Int
  calories    Int
  prepTime    String?
  ingredients Json?    // string[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// User-created custom supplements
model CustomSupplement {
  id        String   @id @default(cuid())
  name      String
  dose      String
  timing    String   // "morning" | "pre-workout" | "post-workout" | "evening"
  notes     String?
  createdAt DateTime @default(now())

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// User's daily supplement protocol
model SupplementProtocol {
  id        String   @id @default(cuid())
  // JSON structure: { morning: [...ids], preWorkout: [...ids], postWorkout: [...ids], evening: [...ids] }
  protocol  Json
  updatedAt DateTime @updatedAt

  // One protocol per user
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================
// Community Models (SetFlow v2.0 - Phase 3)
// ============================================================

// User profile with display settings and privacy controls
model UserProfile {
  id          String  @id @default(cuid())
  displayName String?
  avatarUrl   String?
  bio         String?
  handle      String? @unique // @username format for discovery

  // Privacy settings
  shareStreak   Boolean @default(true)
  shareVolume   Boolean @default(false)
  shareWorkouts Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // One-to-one with User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([handle])
}

// Follow relationship (many-to-many)
model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Goal-based groups (Runna-style)
model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  goalType    String   // strength | weight_loss | muscle_building | endurance | general
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Creator relation
  createdById String
  createdBy   User   @relation("GroupCreator", fields: [createdById], references: [id])

  // Relations
  members    GroupMember[]
  challenges Challenge[]

  @@index([goalType])
  @@index([createdById])
}

// Group membership with roles
model GroupMember {
  id       String   @id @default(cuid())
  role     String   @default("member") // admin | member
  joinedAt DateTime @default(now())

  // Relations
  groupId String
  group   Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

// Challenges (streak, volume, workouts, consistency)
model Challenge {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   // streak | volume | workouts | consistency
  target      Int      // Target number to reach
  startDate   String   // YYYY-MM-DD
  endDate     String   // YYYY-MM-DD
  createdAt   DateTime @default(now())

  // Optional group association
  groupId String?
  group   Group?  @relation(fields: [groupId], references: [id], onDelete: SetNull)

  // Optional badge reward
  badgeId String?

  // Relations
  participants ChallengeParticipant[]

  @@index([groupId])
  @@index([startDate])
  @@index([endDate])
}

// Challenge participation and progress tracking
model ChallengeParticipant {
  id          String    @id @default(cuid())
  progress    Int       @default(0)
  completedAt DateTime?
  joinedAt    DateTime  @default(now())

  // Relations
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
}

// Achievement badges
model Badge {
  id          String  @id @default(cuid())
  name        String
  description String
  imageUrl    String?
  tier        String  // bronze | silver | gold

  // Relations
  userBadges UserBadge[]
}

// User badge collection
model UserBadge {
  id       String   @id @default(cuid())
  earnedAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  badgeId String
  badge   Badge  @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
}

// ============================================================
// Focus Session Models (SetFlow v2.0 - Phase 4)
// ============================================================

// One-off workout sessions outside the regular program
model FocusSession {
  id         String    @id @default(cuid())
  date       String    // YYYY-MM-DD
  focusArea  String?   // "chest" | "back" | "legs" | "shoulders" | "arms" | "core" | "full_body"
  exercises  Json      // Array of { exerciseId, exerciseName }
  sets       Json      @default("[]") // Array of SetLog objects
  duration   Int?      // minutes
  notes      String?
  isComplete Boolean   @default(false)
  startTime  DateTime  @default(now())
  endTime    DateTime?

  // User relation
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
}

// ============================================================
// Gamification Models (SetFlow v2.0 - XP System)
// ============================================================

// User's XP and level tracking
model UserGamification {
  id              String   @id @default(cuid())
  totalXP         Int      @default(0)
  lastLevelUp     Int      @default(1)

  // One-to-one with User
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  xpHistory       XPHistoryEntry[]
  dailyProgress   DailyChallengeProgress[]
  weeklyProgress  WeeklyChallengeProgress[]
}

// XP history entry for tracking rewards
model XPHistoryEntry {
  id              String   @id @default(cuid())
  amount          Int
  source          String   // "workout", "pr", "challenge:daily-workout", etc.
  multiplier      Float    @default(1.0)
  timestamp       DateTime @default(now())

  gamificationId  String
  gamification    UserGamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  @@index([gamificationId])
  @@index([timestamp])
}

// Daily challenge progress tracking
model DailyChallengeProgress {
  id              String   @id @default(cuid())
  challengeId     String   // "daily-workout", "daily-100-reps", etc.
  date            String   // YYYY-MM-DD
  progress        Int      @default(0)
  isComplete      Boolean  @default(false)

  gamificationId  String
  gamification    UserGamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  @@unique([gamificationId, challengeId, date])
  @@index([gamificationId])
  @@index([date])
}

// Weekly challenge progress tracking
model WeeklyChallengeProgress {
  id              String   @id @default(cuid())
  challengeId     String
  weekId          String   // YYYY-MM-DD of Monday
  progress        Int      @default(0)
  isComplete      Boolean  @default(false)

  gamificationId  String
  gamification    UserGamification @relation(fields: [gamificationId], references: [id], onDelete: Cascade)

  @@unique([gamificationId, challengeId, weekId])
  @@index([gamificationId])
  @@index([weekId])
}
